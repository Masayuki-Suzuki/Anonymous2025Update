version: "3.9"

services:
    postgres:
        image: postgres:17
        container_name: postgres
        environment:
            POSTGRES_DB: ${POSTGRES_DB}
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        ports: ["5432:5432"]
        volumes:
            - postgres_data:/var/lib/postgresql/data
        command: >
            postgres -c shared_buffers=128MB
                     -c max_connections=50

    strapi:
        build:
            context: .
            dockerfile: apps/strapi/Dockerfile   # 下の“本番用 Dockerfile”に合わせる
            target: run
        container_name: strapi
        restart: unless-stopped
        environment:
            NODE_ENV: production
            HOST: 0.0.0.0
            PORT: 1337
            DATABASE_CLIENT: ${DATABASE_CLIENT}
            DB_HOST: ${DB_HOST}
            DB_PORT: ${DB_PORT}
            DB_NAME: ${DB_NAME}
            DB_USER: ${DB_USER}
            DB_PASSWORD: ${DB_PASSWORD}
            APP_KEYS: ${APP_KEYS}
            API_TOKEN_SALT: ${API_TOKEN_SALT}
            ADMIN_JWT_SECRET: ${ADMIN_JWT_SECRET}
            TRANSFER_TOKEN_SALT: ${TRANSFER_TOKEN_SALT}
            JWT_SECRET: ${JWT_SECRET}
            ENCRYPTION_KEY: ${ENCRYPTION_KEY}
            # 省リソース系
            STRAPI_LOG_LEVEL: "error"
            NODE_OPTIONS: "--max-old-space-size=512"
        ports: ["1337:1337"]
        depends_on: [postgres]
        volumes:
            - ./apps/strapi/public/uploads:/work/apps/strapi/public/uploads
            - ./apps/strapi/.env:/work/apps/strapi/.env:ro
        healthcheck:
            test: ["CMD", "curl", "-fsS", "http://localhost:1337/_health"]  # Strapi v5+ 用。v4は /admin などに変更
            interval: 30s
            timeout: 5s
            retries: 5
        # （任意）ソフト制限
        mem_limit: 768m
        cpus: "0.75"
        networks: [default]

    # pgadmin は不要なら外してOK
    pgadmin:
        image: dpage/pgadmin4
        container_name: pgadmin
        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
        ports: ["5050:80"]
        depends_on: [postgres]

    frontend:
        build:
            context: .
            dockerfile: ./apps/frontend/Dockerfile
        container_name: frontend
        restart: unless-stopped
        ports:
            - "3003:3000"
        environment:
            NODE_ENV: "production"
            HOST: "0.0.0.0"
            PORT: "3000"
            NEXT_TELEMETRY_DISABLED: "1"
            # 必要ならサーバー専用の秘密値はこちら（クライアントに出さない）
            STRAPI_URL_INTERNAL: ${STRAPI_URL_INTERNAL}
            # クライアントから直接叩かせるなら NEXT_PUBLIC_* を残す
            NEXT_PUBLIC_STRAPI_URL: ${NEXT_PUBLIC_STRAPI_URL}
            NEXT_PUBLIC_GRAPHQL_API_URL: ${NEXT_PUBLIC_GRAPHQL_API_URL}
        depends_on:
            - strapi

volumes:
    postgres_data:

networks:
    #   caddy_net:
    #   	    external: true

    default:
        external:
            name: caddy_net
